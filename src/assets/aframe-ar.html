<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AR View</title>
    
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background-color: transparent !important;
            background: transparent !important;
            overflow: hidden;
        }


        #arjs-video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            z-index: -1 !important;
            margin: 0 !important;
        }
        
        canvas.a-canvas {
            width: 100% !important;
            height: 100% !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 1 !important;
        }
    </style>
</head>

<body style="margin: 0px; overflow: hidden; background: transparent;">
    <script>
        const defaultTargets = [];
        const storedTargets = localStorage.getItem('arTargets');
        const targets = storedTargets ? JSON.parse(storedTargets) : defaultTargets;

        AFRAME.registerComponent('scene-generator', {
            init: function () {
                const scene = this.el;
                
                // Hack para corregir el tamaño al iniciar en móviles
                window.addEventListener('resize', () => {
                    scene.resize();
                });

                targets.forEach(target => {
                    let marker;
                    if (target.markerType === 'barcode') {
                        marker = document.createElement('a-marker');
                        marker.setAttribute('type', 'barcode');
                        marker.setAttribute('value', target.value);
                    } else {
                        marker = document.createElement('a-marker');
                        marker.setAttribute('preset', target.markerType);
                    }

                    let contentElement;
                    const c = target.content;

                    if (c.type === 'image') {
                        contentElement = document.createElement('a-image');
                        contentElement.setAttribute('src', c.src);
                        contentElement.setAttribute('rotation', '-90 0 0');
                        contentElement.setAttribute('width', '2');
                        contentElement.setAttribute('height', '2');
                    } else {
                        contentElement = document.createElement('a-' + c.type);
                        contentElement.setAttribute('position', '0 0.5 0');
                        Object.keys(c).forEach(key => {
                            if (key !== 'type') {
                                if (key === 'animation') contentElement.setAttribute('animation', c[key]);
                                else if (key === 'material') contentElement.setAttribute('material', c[key]);
                                else contentElement.setAttribute(key, c[key]);
                            }
                        });
                    }
                    marker.appendChild(contentElement);
                    scene.appendChild(marker);
                });
            }
        });
    </script>

    <a-scene 
        embedded 
        scene-generator 
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; alpha: true; antialias: true;"
        arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; sourceWidth:1280; sourceHeight:960; displayWidth: auto; displayHeight: auto;'>
        
        <a-entity camera></a-entity>
    
    </a-scene>
</body>
</html>